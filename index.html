<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.png" type="image.png" />
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <title></title>
    <meta charset="UTF-8"/>
    <link rel="stylesheet" href="index.css?ver=5"/>
    <link rel="stylesheet" href="site.css?ver=8"/>
    <script src="js/jquery-3.7.1.min.js" language="javascript"></script>
</head>
<body>
<div id="loading">
    <img src="images/loading.png" />
</div>
<div id="content">
</div>
<script>
function exec_get( url, target ) {
 $.get( url, function( data ) {
  $( target ).html( data );
 });
}
var runners=[];
$(window).on('load', function(){
 $.get("site.json?"+(new Date().getTime()),
  function(data){
   $(document).prop('title', data.title );
    if ( data.header ){
     var header = $('<div class="header">' + ( data.header.img ? '<div><img src="'+data.header.img+'" /></div>' : '' )+ '<span>' + data.header.text + '</span></div>');
     $('#content').append( header );
    }
    for (var r = 0; r < data.content.length; r++ ){
     let row = data.content[r];
     let box_title = row.title != "" ? $('<p>' + row.title + '</p>') : "";
     let box = $('<div class="container"></div>');
     if ( row.foldable ) {
	box_title.click(function(){
		box.toggleClass("folded");
		console.log(this);
	});
	box.addClass("folded");
     }
     box.append( box_title );
     for ( let i = 0; i < row.content.length; i++ ){
      let item = row.content[i];
      let container = $('<div class="contained ' + item.style + '"></div>');
      let text = item.text != "" ? $('<p>' + item.text + '</p>' ) : null;
      if ( item.run ) { 
       let run_target = $('<div></div>');
       runners.push( {run:item.run, target:run_target } );
       container.append( run_target );
       container.append( text );
      }
      if ( item.link ) {
       let img = item.img != "" ? $('<img src="' + item.img + '" />' ) : null;
       let link = $('<a href="' + item.link + '" target="' + (item.new_page ? '_blank' : '_self') + '"></a>' );
       link.append( img );
       link.append( text );
       container.append( link );
      }
      box.append( container );
     }
     $('#content').append( box );
    }
    if ( data.footer ){
     let l=data.footer.link;
     let footer = $('<div class="footer"><span>' + ( l ? '<a href="'+l+'">' : '') + data.footer.text + ( l ? '</a>' : '' ) + '</span></div>');
     $('#content').append( footer );
    }

    for ( let r = 0; r < runners.length; r++ ){
     let run=runners[r];
     let func=function() { exec_get( run.run, run.target ) };
     setTimeout( function(){ func(); setInterval( func, 5000 ) }, 500  );
    }
    console.log( runners );
    $('#loading').fadeOut( {
     'duration': 100,
     'complete':
      function() {
       $('#content').fadeIn( { 'duration':100 } );
      }
    });
  }, 'json').fail(function(){alert("Missing 'site.json'");});
});
</script>
</body>
</html>
